services:
  nginx:
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=frontend"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-http.rule=Host(`${COMPOSE_SERVER_DOMAIN}`)"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-http.entrypoints=web"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-http.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}.entrypoints=websecure"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}.rule=Host(`${COMPOSE_SERVER_DOMAIN}`)"

  vllm:
    # NGC image required for Blackwell GPU support and NVFP4 quantization
    image: nvcr.io/nvidia/vllm:26.01-py3
    # NGC container requires explicit 'vllm serve' command
    command: "vllm serve ${VLLM_MODEL:-facebook/opt-125m} ${VLLM_OPTIONS:-}"
    restart: unless-stopped
    # Add support for GPU on the server.
    deploy:
      replicas: 1
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  postgres:
    restart: unless-stopped

  litellm:
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=frontend"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-litellm-http.rule=Host(`${COMPOSE_LITELLM_DOMAIN}`)"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-litellm-http.entrypoints=web"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-litellm-http.middlewares=redirect-to-https"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-litellm.entrypoints=websecure"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-litellm.rule=Host(`${COMPOSE_LITELLM_DOMAIN}`)"
      - "traefik.http.services.${COMPOSE_PROJECT_NAME}-litellm.loadbalancer.server.port=4000"