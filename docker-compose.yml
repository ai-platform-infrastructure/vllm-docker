networks:
  frontend:
    external: true
  app:
    driver: bridge
    internal: false

services:
  nginx:
    image: nginxinc/nginx-unprivileged:alpine
    networks:
      - app
      - frontend
    depends_on:
      - vllm
    ports:
      - '8080'
    volumes:
      - ./.docker/templates:/etc/nginx/templates:ro
      - ./index.html:/app/index.html
    environment:
      NGINX_WEB_ROOT: /app
      NGINX_PORT: 8080
      NGINX_ALLOW_METRICS_IP: "${NGINX_ALLOW_METRICS_IP}"
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=frontend"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}.rule=Host(`${COMPOSE_DOMAIN}`)"

  vllm:
    image: vllm/vllm-openai
    command: "--model ${VLLM_MODEL:-facebook/opt-125m} ${VLLM_OPTIONS:-}"
    shm_size: "${SHM_SIZE:-8gb}"
    networks:
      - app
    extra_hosts:
      - "host.docker.internal:host-gateway"
    ports:
      - "8000"
    environment:
      - "HUGGING_FACE_HUB_TOKEN=${HUGGING_FACE_HUB_TOKEN:?}"
      - "VLLM_API_KEY=${VLLM_API_KEY:?}"
      - "VLLM_USE_FLASHINFER_MOE_FP4=${VLLM_USE_FLASHINFER_MOE_FP4:-}"
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:8000/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    volumes:
      - ./.docker/data/vllm/:/root/.cache/huggingface:rw
      - ./.docker/data/vllm-cache/:/root/.cache/vllm:rw

  postgres:
    image: postgres:17
    environment:
      POSTGRES_DB: litellm
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?}
      POSTGRES_HOST: localhost
    networks:
      - app
    ports:
      - "5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready" ]
      interval: 1s
      timeout: 5s
      retries: 10
    volumes:
      - .docker/data/postgres:/var/lib/postgresql/data

  litellm:
    image: ghcr.io/berriai/litellm:${LITELLM_IMAGE:-v1.81.3-stable}
    command: [
      "--config", "/app/config.yaml",
      "--detailed_debug",
      "--num_workers", "8"
    ]
    environment:
      LITELLM_MASTER_KEY: ${LITELLM_MASTER_KEY:?}
      LITELLM_SALT_KEY: ${LITELLM_SALT_KEY:?}
      DATABASE_URL: "postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:?}@postgres:5432/litellm"
      STORE_MODEL_IN_DB: "False" # disable adding models to proxy via UI
    networks:
      - app
      - frontend
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=frontend"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-litellm.rule=Host(`${COMPOSE_LITELLM_DOMAIN}`)"
      - "traefik.http.services.${COMPOSE_PROJECT_NAME}-litellm.loadbalancer.server.port=4000"
    ports:
      - "4000"
    depends_on:
      - postgres
    healthcheck:
      test: [ "CMD-SHELL", "python3 -c \"import urllib.request; urllib.request.urlopen('http://localhost:4000/health/liveliness')\"" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ./litellm_config.yaml:/app/config.yaml
      - ./guardrails/message_overflow.py:/app/message_overflow.py
